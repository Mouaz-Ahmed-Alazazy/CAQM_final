{% extends 'accounts/base.html' %}

{% block title %}Queue Management - CAQM{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-tasks"></i> Queue Management</h2>
        <p class="text-muted">
            {% if assigned_doctor %}
            Dr. {{ assigned_doctor.user.get_full_name }} - {{ assigned_doctor.get_specialization_display }} |
            {% endif %}
            {{ today_date|date:"F d, Y" }}
        </p>
    </div>
</div>

{% if not assigned_doctor %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle"></i> No doctor assigned. Please contact administrator.
</div>
{% elif not queue %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> No queue available for today.
</div>
{% else %}

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card border-secondary">
            <div class="card-body text-center py-2">
                <h4 class="mb-0">{{ statistics.total }}</h4>
                <small class="text-muted">Total</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-warning">
            <div class="card-body text-center py-2">
                <h4 class="text-warning mb-0">{{ statistics.waiting }}</h4>
                <small class="text-muted">Waiting</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-primary">
            <div class="card-body text-center py-2">
                <h4 class="text-primary mb-0">{{ statistics.in_progress }}</h4>
                <small class="text-muted">In Progress</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-success">
            <div class="card-body text-center py-2">
                <h4 class="text-success mb-0">{{ statistics.completed }}</h4>
                <small class="text-muted">Completed</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card border-danger">
            <div class="card-body text-center py-2">
                <h4 class="text-danger mb-0">{{ statistics.no_show }}</h4>
                <small class="text-muted">No Show</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <form method="post" action="{% url 'nurses:call_next_patient' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary w-100 h-100" {% if current_patient or not waiting_patients %}disabled{% endif %}>
                <i class="fas fa-bell"></i><br>Call Next
            </button>
        </form>
    </div>
</div>

<!-- Current Patient -->
{% if current_patient %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-stethoscope"></i> In Consultation</h5>
                <span class="badge bg-light text-dark">Started: {{ current_patient.consultation_start_time|time:"h:i A" }}</span>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-1 text-center">
                        <span class="badge bg-success fs-4">#{{ current_patient.position }}</span>
                    </div>
                    <div class="col-md-4">
                        <h5 class="mb-0">{{ current_patient.patient.user.get_full_name }}</h5>
                        <small class="text-muted">{{ current_patient.patient.user.phone|default:"No phone" }}</small>
                    </div>
                    <div class="col-md-3">
                        <span class="text-muted">Wait time:</span>
                        <strong>{{ current_patient.get_wait_time }} min</strong>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <form method="post" action="{% url 'nurses:end_consultation' current_patient.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-lg">
                                <i class="fas fa-stop-circle"></i> End Consultation
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- All Patients Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> All Patients in Queue</h5>
            </div>
            <div class="card-body">
                {% if all_patients %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 80px;">Position</th>
                                <th>Patient Name</th>
                                <th>Phone</th>
                                <th>Check-in</th>
                                <th>Wait Time</th>
                                <th>Status</th>
                                <th style="width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pq in all_patients %}
                            <tr class="{% if pq.status == 'IN_PROGRESS' %}table-success{% elif pq.status == 'TERMINATED' %}table-secondary{% elif pq.status == 'NO_SHOW' %}table-danger{% elif pq.is_emergency %}table-warning{% endif %}">
                                <td>
                                    <span class="badge {% if pq.is_emergency %}bg-danger{% else %}bg-primary{% endif %}">
                                        #{{ pq.position }}
                                    </span>
                                    {% if pq.is_emergency %}
                                    <i class="fas fa-exclamation-triangle text-danger" title="Emergency"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ pq.patient.user.get_full_name }}</strong>
                                    {% if pq.checkedin_via_qrcode %}
                                    <i class="fas fa-qrcode text-info" title="QR Check-in"></i>
                                    {% endif %}
                                </td>
                                <td>{{ pq.patient.user.phone|default:"-" }}</td>
                                <td>{{ pq.check_in_time|time:"h:i A" }}</td>
                                <td>
                                    {% if pq.status == 'TERMINATED' %}
                                    {{ pq.get_consultation_duration }} min
                                    {% else %}
                                    {{ pq.get_wait_time }} min
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pq.status == 'WAITING' %}
                                    <span class="badge bg-warning text-dark">Waiting</span>
                                    {% elif pq.status == 'IN_PROGRESS' %}
                                    <span class="badge bg-success">In Progress</span>
                                    {% elif pq.status == 'TERMINATED' %}
                                    <span class="badge bg-secondary">Completed</span>
                                    {% elif pq.status == 'NO_SHOW' %}
                                    <span class="badge bg-danger">No Show</span>
                                    {% elif pq.status == 'EMERGENCY' %}
                                    <span class="badge bg-danger">Emergency</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if pq.status == 'WAITING' %}
                                        {% if not current_patient %}
                                        <form method="post" action="{% url 'nurses:start_consultation' pq.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-success" title="Start Consultation">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        <form method="post" action="{% url 'nurses:mark_no_show' pq.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Mark No Show">
                                                <i class="fas fa-user-slash"></i>
                                            </button>
                                        </form>
                                    {% elif pq.status == 'IN_PROGRESS' %}
                                        <form method="post" action="{% url 'nurses:end_consultation' pq.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger" title="End Consultation">
                                                <i class="fas fa-stop"></i> End
                                            </button>
                                        </form>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle"></i> No patients in queue yet.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Back Button -->
<div class="row mt-4">
    <div class="col-12">
        <a href="{% url 'nurses:nurse_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
